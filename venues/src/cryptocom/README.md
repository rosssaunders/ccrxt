# Crypto.com Exchange API Implementation

This module provides a comprehensive implementation of the Crypto.com Exchange REST API, featuring:

## Features

- **Public REST API**: Market data endpoints for instruments, order books, trades, and candlestick data
- **Private REST API**: Authenticated endpoints for account management, trading, and order history
- **Rate Limiting**: Exchange-specific rate limits for optimal API usage
- **Error Handling**: Comprehensive error mapping and handling
- **Request Signing**: HMAC SHA256 authentication for private endpoints
- **Time Window Management**: Automatic validation of 7-day maximum time windows for historical data

## API Documentation

- [Public REST API](./public_rest_api.md) - Market data and public information endpoints
- [Private REST API](./private_rest_api.md) - Authenticated trading and account management endpoints

## Quick Start

### Public API Usage

```rust
use venues::cryptocom::public::RestClient;

// Create public client
let client = RestClient::new("https://deriv-api.crypto.com", reqwest::Client::new());

// Get instruments
let instruments = client.get_instruments().await?;

// Get order book
let book_request = GetBookRequest {
    instrument_name: "BTCUSD-PERP".to_string(),
    depth: Some(20),
};
let order_book = client.get_book(book_request).await?;
```

### Private API Usage

```rust
use venues::cryptocom::private::RestClient;
use rest::secrets::SecretValue;

// Create private client with encrypted credentials
let client = RestClient::new(
    api_key,
    api_secret,
    "https://deriv-api.crypto.com",
    reqwest::Client::new(),
);

// Get account balances
let accounts = client.get_accounts().await?;

// Place an order
let order_request = CreateOrderRequest {
    instrument_name: "BTCUSD-PERP".to_string(),
    side: "BUY".to_string(),
    order_type: "LIMIT".to_string(),
    quantity: "0.001".to_string(),
    price: Some("50000.0".to_string()),
    time_in_force: Some("GOOD_TILL_CANCEL".to_string()),
    client_oid: Some("my-order-123".to_string()),
};
let order_result = client.create_order(order_request).await?;
```

## Important API Changes

### 7-Day Time Window Limitation

**As of the latest update**, all endpoints that support time-based queries now have a **maximum allowed time window of 7 days**. This affects:

- Order history endpoints (`get_order_history`, `get_order_history_by_instrument`, etc.)
- Trade history endpoints (`get_trades`)
- Balance history endpoints (`user_balance_history`)
- Transaction history endpoints (`get_transactions`, `get_deposit_history`, `get_withdrawal_history`)

### Implementation Considerations

When using time-based parameters (`start_time` and `end_time`):

1. **Validate Time Windows**: Ensure `end_time - start_time â‰¤ 604,800,000` milliseconds (7 days)
2. **Handle Errors**: Properly handle time window validation errors
3. **Use Pagination**: For data spanning more than 7 days, implement pagination
4. **Default Behavior**: If no time range is specified, APIs default to the last 24 hours

### Example: Correct Time Window Usage

```rust
use venues::cryptocom::private::rest::{GetTradesRequest, GetOrderHistoryRequest};

// Correct: 24-hour window
let trades_request = GetTradesRequest {
    instrument_name: Some("BTCUSD-PERP".to_string()),
    start_time: Some("1640995200000".to_string()), // Start time
    end_time: Some("1641081600000".to_string()),   // End time (24 hours later)
    limit: Some(100),
};

// Correct: 7-day window (maximum allowed)
let history_request = GetOrderHistoryRequest {
    instrument_name: Some("BTCUSD-PERP".to_string()),
    start_time: Some("1640995200000".to_string()), // Start time
    end_time: Some("1641600000000".to_string()),   // End time (7 days later)
    limit: Some(100),
};
```

## Rate Limits

The implementation respects Crypto.com's rate limits:

- **Public endpoints**: 100 requests per 10 seconds
- **Private general endpoints**: 1 request per second
- **Order-related endpoints**: 3 requests per second

## Authentication

Private API endpoints require:

- **API Key**: Your unique API key identifier
- **API Secret**: Used for HMAC SHA256 request signing
- **Nonce**: Unique incrementing number for each request
- **Signature**: HMAC SHA256 signature of the request parameters

The signature is generated by concatenating `method + id + api_key + params + nonce` and signing with your API secret.

## Supported Endpoints

### Public Endpoints
- Get instruments
- Get order book
- Get recent trades
- Get candlestick data
- Get ticker information
- Get insurance fund info
- Get risk parameters

### Private Endpoints
- Account management (balances, settings, leverage)
- Order management (create, cancel, amend, history)
- Trade history and execution data
- Position management
- Transfers and withdrawals
- Staking operations

## Error Handling

The implementation provides comprehensive error handling with:

- Exchange-specific error code mapping
- Detailed error messages
- Proper HTTP status code handling
- Rate limit error detection
- Time window validation errors

## Testing

The module includes comprehensive test coverage for:

- Request/response serialization
- Parameter validation
- Error handling scenarios
- Authentication signing
- Rate limiting behavior

## Security

- API credentials are stored using encrypted `ExposableSecret` types
- Request signing follows Crypto.com's security requirements
- Nonce values are properly managed to prevent replay attacks
- All HTTP requests use TLS encryption

## Performance

- Connection pooling through reused `reqwest::Client`
- Efficient JSON serialization/deserialization
- Automatic rate limiting to prevent API quota exhaustion
- Optimized for high-frequency trading applications